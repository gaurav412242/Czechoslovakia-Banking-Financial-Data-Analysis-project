-- CREATING STORAGE INTEGRATION BETWEEN AWS S3 AND SNOWFLAKE 
CREATE OR REPLACE STORAGE INTEGRATION CHECZ_BANK_INT
TYPE = EXTERNAL_STAGE 
STORAGE_PROVIDER = S3 
ENABLED =TRUE
STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::003902404202:role/checzbank_role'
STORAGE_ALLOWED_LOCATIONS = ('s3://checzbank/');

DESC INTEGRATION CHECZ_BANK_INT;

-- CREATING FILE FORMAT 
create or replace file format CSV
    type = 'csv' 
    compression = 'none' 
    field_delimiter = ','
    field_optionally_enclosed_by = 'none'
    skip_header = 1 ;

-- CREATING STAGE 
CREATE OR REPLACE STAGE BANK
URL = 'S3://checzbank'
FILE_FORMAT = CSV 
STORAGE_INTEGRATION = CHECZ_BANK_INT ;

LIST @BANK;

SHOW STAGES ; -- WILL SHOW ALL THE STAGES CREATED 

--CREATING PIPE FOR EVERY FOLDER IN S3  AND TABLE SNOWFLAKE 
CREATE OR REPLACE PIPE CHECZ_BANK_ACCOUNT
AUTO_INGEST = TRUE AS
COPY INTO "CHECZ_BANK"."PUBLIC"."ACCOUNT"
FROM '@checzbank/account/'
FILE_FORMAT = CSV;

CREATE OR REPLACE PIPE CHECZ_BANK_CARD
AUTO_INGEST = TRUE AS
COPY INTO CHECZ_BANK.PUBLIC.CARD
FROM '@checzbank/card/'
FILE_FORMAT = CSV;

CREATE OR REPLACE PIPE CHECZ_BANK_CLIENT 
AUTO_INGEST = TRUE AS
COPY INTO CHECZ_BANK.PUBLIC.CLIENT
FROM '@checzbank/client/'
FILE_FORMAT = CSV;


CREATE OR REPLACE PIPE CHECZ_BANK_DISP 
AUTO_INGEST = TRUE AS
COPY INTO CHECZ_BANK.PUBLIC.DISP
FROM '@checzbank/disp/'
FILE_FORMAT = CSV;

CREATE OR REPLACE PIPE CHECZ_BANK_DISTRICT 
AUTO_INGEST = TRUE AS
COPY INTO CHECZ_BANK.PUBLIC.DISTRICT
FROM '@checzbank/district/'
FILE_FORMAT = CSV;

CREATE OR REPLACE PIPE CHECZ_BANK_LOAN 
AUTO_INGEST = TRUE AS
COPY INTO CHECZ_BANK.PUBLIC.LOAN
FROM '@checzbank/loan/'
FILE_FORMAT = CSV;

CREATE OR REPLACE PIPE CHECZ_BANK_ORDER1 
AUTO_INGEST = TRUE AS
COPY INTO CHECZ_BANK.PUBLIC.ORDER1
FROM '@checzbank/order1/'
FILE_FORMAT = CSV;

CREATE OR REPLACE PIPE CHECZ_BANK_TRANSACTION 
AUTO_INGEST = TRUE AS
COPY INTO CHECZ_BANK.PUBLIC.TRANSACTION
FROM '@checzbank/transaction/'
FILE_FORMAT = CSV;

SHOW PIPES;
